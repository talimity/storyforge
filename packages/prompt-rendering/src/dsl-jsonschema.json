{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "urn:storyforge:slot-spec-authorable",
  "title": "SlotSpec schema",
  "description": "The subset of SlotSpec authors can edit in the UI (priority is controlled by the template builder).",
  "type": "object",
  "additionalProperties": false,
  "required": ["plan"],
  "properties": {
    "when": {
      "$ref": "#/$defs/ConditionRef",
      "description": "Optional condition gating this slot."
    },
    "budget": { "$ref": "#/$defs/Budget" },
    "plan": {
      "type": "array",
      "minItems": 1,
      "items": { "$ref": "#/$defs/PlanNode" },
      "description": "Ordered list of plan nodes executed to fill this slot."
    },
    "meta": {
      "type": "object",
      "description": "Arbitrary metadata; ignored by the renderer.",
      "default": {},
      "additionalProperties": true
    }
  },
  "$defs": {
    "Role": {
      "type": "string",
      "enum": ["system", "user", "assistant"],
      "description": "Chat message role."
    },
    "DataRef": {
      "type": "object",
      "additionalProperties": false,
      "required": ["source"],
      "properties": {
        "source": {
          "type": "string",
          "description": "Named source from the task's SourceSpec, or reserved helper ($item, $index, $parent, $globals, $ctx)."
        },
        "args": {
          "description": "Optional arguments passed to the source resolver (shape is task-defined).",
          "oneOf": [
            { "type": "object", "additionalProperties": true },
            { "type": "array" },
            { "type": "string" },
            { "type": "number" },
            { "type": "boolean" },
            { "type": "null" }
          ]
        }
      },
      "examples": [
        { "source": "turns", "args": { "order": "desc", "limit": 50 } },
        { "source": "$item", "args": { "path": "intentKind" } },
        { "source": "$globals" }
      ]
    },
    "Budget": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "maxTokens": {
          "type": "integer",
          "minimum": 1,
          "description": "Max tokens for this scope (rough estimator)."
        }
      }
    },
    "ConditionRef": {
      "description": "Conditional expression evaluated against a DataRef.",
      "oneOf": [
        {
          "type": "object",
          "additionalProperties": false,
          "required": ["type", "ref"],
          "properties": {
            "type": { "const": "exists", "description": "Ref is defined (not undefined/null)." },
            "ref": { "$ref": "#/$defs/DataRef" }
          }
        },
        {
          "type": "object",
          "additionalProperties": false,
          "required": ["type", "ref"],
          "properties": {
            "type": {
              "const": "nonEmpty",
              "description": "Ref yields a non-empty value (strings/arrays/objects)."
            },
            "ref": { "$ref": "#/$defs/DataRef" }
          }
        },
        {
          "type": "object",
          "additionalProperties": false,
          "required": ["type", "ref", "value"],
          "properties": {
            "type": {
              "enum": ["eq", "neq", "gt", "lt"],
              "description": "Comparison operators."
            },
            "ref": { "$ref": "#/$defs/DataRef" },
            "value": {
              "description": "Literal to compare against.",
              "oneOf": [
                { "type": "string" },
                { "type": "number" },
                { "type": "boolean" },
                { "type": "object", "additionalProperties": true },
                { "type": "array" },
                { "type": "null" }
              ]
            }
          }
        }
      ]
    },
    "MessageBlock": {
      "type": "object",
      "additionalProperties": false,
      "required": ["role"],
      "properties": {
        "role": { "$ref": "#/$defs/Role" },
        "content": {
          "type": "string",
          "description": "Literal text (supports {{}} interpolation)."
        },
        "from": {
          "$ref": "#/$defs/DataRef",
          "description": "If set, content is taken from this DataRef."
        },
        "skipIfEmptyInterpolation": {
          "type": "boolean",
          "default": false,
          "description": "Skip this message if the interpolated content is empty."
        }
      },
      "anyOf": [{ "required": ["content"] }, { "required": ["from"] }]
    },
    "PlanNode": {
      "description": "Discriminated union of plan nodes.",
      "oneOf": [
        { "$ref": "#/$defs/PlanMessageNode" },
        { "$ref": "#/$defs/PlanForEachNode" },
        { "$ref": "#/$defs/PlanIfNode" }
      ]
    },
    "PlanMessageNode": {
      "type": "object",
      "additionalProperties": false,
      "required": ["kind", "role"],
      "properties": {
        "kind": { "const": "message" },
        "budget": { "$ref": "#/$defs/Budget" },
        "role": { "$ref": "#/$defs/Role" },
        "content": { "type": "string" },
        "from": { "$ref": "#/$defs/DataRef" },
        "skipIfEmptyInterpolation": { "type": "boolean", "default": false }
      },
      "anyOf": [{ "required": ["content"] }, { "required": ["from"] }],
      "examples": [
        {
          "kind": "message",
          "role": "user",
          "content": "[{{item.turnNo}}] {{item.authorName}}: {{item.content}}"
        }
      ]
    },
    "PlanForEachNode": {
      "type": "object",
      "additionalProperties": false,
      "required": ["kind", "source", "map"],
      "properties": {
        "kind": { "const": "forEach" },
        "source": {
          "$ref": "#/$defs/DataRef",
          "description": "Array-valued DataRef to iterate."
        },
        "order": {
          "type": "string",
          "enum": ["asc", "desc"],
          "default": "asc",
          "description": "Optional override; some tasks also accept order in source.args."
        },
        "fillDir": {
          "type": "string",
          "enum": ["append", "prepend"],
          "default": "append",
          "description": "Where to place each iteration's output in the slot buffer."
        },
        "limit": {
          "type": "integer",
          "minimum": 1,
          "description": "Max items to process (optional)."
        },
        "map": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/$defs/PlanNode" },
          "description": "Nested plan executed for each item. Exposes $item and $index."
        },
        "budget": { "$ref": "#/$defs/Budget" }
      },
      "examples": [
        {
          "kind": "forEach",
          "source": { "source": "turns", "args": { "order": "desc", "limit": 50 } },
          "fillDir": "prepend",
          "map": [
            {
              "kind": "message",
              "role": "user",
              "content": "[{{item.turnNo}}] {{item.authorName}}: {{item.content}}"
            }
          ]
        }
      ]
    },
    "PlanIfNode": {
      "type": "object",
      "additionalProperties": false,
      "required": ["kind", "when", "then"],
      "properties": {
        "kind": { "const": "if" },
        "when": { "$ref": "#/$defs/ConditionRef" },
        "then": {
          "type": "array",
          "items": { "$ref": "#/$defs/PlanNode" }
        },
        "else": {
          "type": "array",
          "items": { "$ref": "#/$defs/PlanNode" }
        }
      },
      "examples": [
        {
          "kind": "if",
          "when": {
            "type": "nonEmpty",
            "ref": { "source": "$item", "args": { "path": "intentKind" } }
          },
          "then": [
            {
              "kind": "if",
              "when": {
                "type": "eq",
                "ref": { "source": "$item", "args": { "path": "intentKind" } },
                "value": "manual_control"
              },
              "then": [
                {
                  "kind": "message",
                  "role": "user",
                  "content": "[Turn {{item.turnNo}}] {{item.authorName}}\nI'll write this turn myself.\n-> {{item.authorName}}: {{item.content}}"
                }
              ],
              "else": [
                {
                  "kind": "message",
                  "role": "user",
                  "content": "[Turn {{item.turnNo}}] {{item.authorName}}\n{{item.intentPrompt}}]"
                },
                {
                  "kind": "message",
                  "role": "assistant",
                  "content": "-> {{item.authorName}}: {{item.content}}"
                }
              ]
            }
          ],
          "else": [
            {
              "kind": "message",
              "role": "user",
              "content": "[Turn {{item.turnNo}}] {{item.authorName}}\nI'll write this turn myself.\n-> {{item.authorName}}: {{item.content}}"
            }
          ]
        }
      ]
    }
  },
  "examples": [
    {
      "budget": { "maxTokens": 32768 },
      "plan": [
        {
          "kind": "forEach",
          "source": { "source": "turns", "args": { "order": "desc", "limit": 50 } },
          "fillDir": "prepend",
          "map": [
            {
              "kind": "message",
              "role": "user",
              "content": "[{{item.turnNo}}] {{item.authorName}}: {{item.content}}"
            }
          ]
        }
      ],
      "meta": {}
    }
  ]
}
